SELECT sent_month,
    id_account,
    cnt_per_accn /cnt_per_month * 100 AS sent_msg_percent_from_this_month,
    first_sent_date,
    last_sent_date
FROM(
SELECT DISTINCT es.id_account as id_account,
    DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH) AS sent_month,
    COUNT(es.id_message) OVER(PARTITION BY es.id_account,  DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS cnt_per_accn,
    COUNT(es.id_message) OVER(PARTITION BY DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS cnt_per_month,
    MIN(DATE_ADD(s.date, INTERVAL es.sent_date DAY)) OVER(PARTITION BY es.id_account, DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS first_sent_date,
    MAX(DATE_ADD(s.date, INTERVAL es.sent_date DAY)) OVER(PARTITION BY es.id_account, DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) AS last_sent_date
FROM `data-analytics-mate.DA.account_session` AS acs
INNER JOIN `data-analytics-mate.DA.session` AS s
ON s.ga_session_id = acs.ga_session_id
INNER JOIN `data-analytics-mate.DA.email_sent` AS es
ON es.id_account = acs.account_id)
